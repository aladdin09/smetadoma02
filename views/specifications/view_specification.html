{{extend 'layout_gentelella_bs5.html'}}

{{block header}}
{{if breadcrumbs:}}
<nav aria-label="breadcrumb" class="mb-2">
  <ol class="breadcrumb mb-0">
    {{for crumb in breadcrumbs:}}
    {{if crumb['url']:}}
    <li class="breadcrumb-item"><a href="{{=crumb['url']}}">{{=crumb['label']}}</a></li>
    {{else:}}
    <li class="breadcrumb-item active" aria-current="page">{{=crumb['label']}}</li>
    {{pass}}
    {{pass}}
  </ol>
</nav>
{{pass}}
{{end}}

<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Информация о спецификации</h5>
        </div>
        <div class="card-body">
          <table class="table table-borderless">
            <tr><th width="40%">ID:</th><td>#{{=specification_obj.id}}</td></tr>
            <tr>
              <th>Клиент:</th>
              <td><a href="{{=URL('customers', 'customer', args=[specification_obj.customer_id])}}">{{=customer.name if customer else 'Неизвестно'}}</a></td>
            </tr>
            <tr>
              <th>Статус:</th>
              <td>
                {{if status:}}
                  {{status_color = status_colors.get(status.id, 'secondary') if status_colors else 'secondary'}}
                  <span class="badge bg-{{=status_color}}">{{=status.name}}</span>
                {{else:}}
                  <span class="badge bg-secondary">Неизвестно</span>
                {{pass}}
              </td>
            </tr>
            <tr><th>Дата изменения статуса:</th><td>{{=specification_obj.status_changed_on.strftime('%d.%m.%Y %H:%M') if specification_obj.status_changed_on else '-'}}</td></tr>
            {{if next_step:}}<tr><th>Следующий шаг:</th><td>{{=next_step.name}}</td></tr>{{pass}}
            {{if specification_obj.execution_time:}}<tr><th>Время выполнения:</th><td>{{=specification_obj.execution_time}} дней</td></tr>{{pass}}
            {{if specification_obj.deadline:}}<tr><th>Дедлайн:</th><td>{{=specification_obj.deadline.strftime('%d.%m.%Y %H:%M')}}</td></tr>{{pass}}
            <tr><th>Общая сумма:</th><td><strong>{{=f"{float(specification_obj.total_amount or 0):,.2f}".replace(',', ' ')}} ₽</strong></td></tr>
            {{if specification_obj.description:}}<tr><th>Описание:</th><td>{{=specification_obj.description}}</td></tr>{{pass}}
            <tr><th>Дата создания:</th><td>{{=specification_obj.created_on.strftime('%d.%m.%Y %H:%M') if specification_obj.created_on else '-'}}</td></tr>
            <tr><th>Дата изменения:</th><td>{{=specification_obj.modified_on.strftime('%d.%m.%Y %H:%M') if specification_obj.modified_on else '-'}}</td></tr>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-list"></i> Позиции спецификации</h5>
          <div class="d-flex gap-2">
            <a href="{{=URL('specifications', 'update_prices', args=[specification_obj.id])}}" class="btn btn-warning btn-sm" title="Обновить цены из номенклатуры" onclick="return confirm('Обновить цены всех позиций из номенклатуры?');">
              <i class="bi bi-arrow-clockwise"></i> Обновить цены
            </a>
            {{if commercial_proposal:}}
            <a href="{{=URL('specifications', 'view_commercial_proposal_page', args=[commercial_proposal.id])}}" class="btn btn-light btn-sm" target="_blank" title="Сформировать КП (А4, таблица)">
              <i class="bi bi-file-earmark-text"></i> Сформировать КП
            </a>
            {{pass}}
            <button type="button" class="btn btn-light btn-sm" onclick="openNomenclatureSidebar()">
              <i class="bi bi-plus"></i> Добавить позицию
            </button>
          </div>
        </div>
        <div class="card-body">
          {{if specification_items_grouped:}}
          <div class="table-responsive">
            <table id="specItemsTable" class="table table-striped table-hover">
              <thead><tr><th>Тип позиции / Позиция номенклатуры</th><th>Количество</th><th>Единица</th><th>Цена</th><th>Итого</th><th>Действия</th></tr></thead>
              <tbody>
                {{for type_name, items in specification_items_grouped:}}
                <tr class="tree-parent table-secondary">
                  <td colspan="1"><strong><i class="bi bi-folder2-open"></i> {{=type_name}}</strong></td>
                  <td></td><td></td><td></td><td></td><td></td>
                </tr>
                {{for item in items:}}
                <tr class="tree-child" data-item-id="{{=item.specification_items.id}}" data-price="{{=item.specification_items.price or 0}}">
                  <td class="ps-4">{{=item.nomenclature_items.description if item.nomenclature_items and (item.nomenclature_items.description or '').strip() else item.specification_items.item_name}}</td>
                  <td class="editable-quantity" data-quantity="{{=item.specification_items.quantity}}">{{=item.specification_items.quantity}}</td>
                  <td>{{=item.specification_items.unit}}</td>
                  <td>{{=f"{float(item.specification_items.price or 0):,.2f}".replace(',', ' ')}} ₽</td>
                  <td class="item-total"><strong>{{=f"{float(item.specification_items.total or 0):,.2f}".replace(',', ' ')}} ₽</strong></td>
                  <td>
                    <a href="{{=URL('specifications', 'delete_item', args=[item.specification_items.id])}}" class="btn btn-sm btn-danger" title="Удалить" onclick="return confirm('Удалить эту позицию?');">
                      <i class="bi bi-trash"></i>
                    </a>
                  </td>
                </tr>
                {{pass}}
                {{pass}}
              </tbody>
              <tfoot>
                <tr class="table-info">
                  <th colspan="4" class="text-right">Итого:</th>
                  <th id="specTotalAmount">{{=f"{float(specification_obj.total_amount or 0):,.2f}".replace(',', ' ')}} ₽</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
          {{else:}}
          <p class="text-muted text-center">Позиции спецификации отсутствуют</p>
          {{pass}}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Панель справа: выбор позиций номенклатуры -->
<div class="nomenclature-sidebar-overlay" id="nomenclatureSidebarOverlay" onclick="closeNomenclatureSidebar()"></div>
<div class="nomenclature-sidebar" id="nomenclatureSidebar">
  <div class="nomenclature-sidebar-header">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="bi bi-cubes"></i> Добавить позицию из номенклатуры</h4>
      <button type="button" class="btn btn-light btn-sm" onclick="closeNomenclatureSidebar()">
        <i class="bi bi-times"></i>
      </button>
    </div>
  </div>
  <div class="nomenclature-sidebar-body">
    <form method="post" action="{{=URL('specifications', 'add_items_from_nomenclature', args=[specification_obj.id])}}" id="nomenclatureSelectForm">
      <input type="hidden" name="nomenclature_item_ids" id="nomenclatureItemIdsHidden" value="">
      <!-- Фильтр по типу номенклатуры -->
      <div class="mb-3">
        <label for="nomenclatureTypeFilter" class="form-label small text-muted">Фильтр по типу:</label>
        <select id="nomenclatureTypeFilter" class="form-select form-select-sm">
          <option value="">Все типы</option>
          {{if nomenclature_item_types:}}
          {{for nom_type in nomenclature_item_types:}}
          <option value="{{=nom_type.id}}">{{=nom_type.name}}</option>
          {{pass}}
          {{pass}}
        </select>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-hover" id="nomenclatureTable">
          <thead class="thead-light sticky-top">
            <tr>
              <th style="width: 40px;"></th>
              <th style="min-width: 150px; width: 150px;">Номер</th>
              <th>Описание</th>
              <th>Тип</th>
              <th>Стоимость</th>
            </tr>
          </thead>
          <tbody>
            {{if nomenclature_items:}}
            {{for nom in nomenclature_items:}}
            <tr data-type-id="{{=nom.nomenclature_items.item_type_id or ''}}">
              <td>
                <input type="checkbox" name="nomenclature_cb" value="{{=nom.nomenclature_items.id}}" class="nomenclature-cb" form="nomenclatureSelectForm">
              </td>
              <td>{{=nom.nomenclature_items.item_number}}</td>
              <td>{{=nom.nomenclature_items.description[:80] + '…' if nom.nomenclature_items.description and len(nom.nomenclature_items.description) > 80 else (nom.nomenclature_items.description or '-')}}</td>
              <td>{{=nom.nomenclature_item_types.name if nom.nomenclature_item_types else '-'}}</td>
              <td>{{=f"{float(nom.nomenclature_items.total_cost or 0):,.2f}".replace(',', ' ')}} ₽</td>
            </tr>
            {{pass}}
            {{else:}}
            <tr><td colspan="5" class="text-muted text-center">Номенклатура пуста. <a href="{{=URL('nomenclature_items', 'create')}}">Создайте позиции</a>.</td></tr>
            {{pass}}
          </tbody>
        </table>
      </div>
      <div class="nomenclature-sidebar-footer">
        <button type="submit" class="btn btn-primary btn-block" id="nomenclatureAddBtn">
          <i class="bi bi-plus"></i> Добавить
        </button>
        <button type="button" class="btn btn-secondary btn-block mt-2" onclick="closeNomenclatureSidebar()">Отмена</button>
      </div>
    </form>
  </div>
</div>

<style>
.nomenclature-sidebar-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); z-index: 1040; display: none;
}
.nomenclature-sidebar-overlay.show { display: block; }
.nomenclature-sidebar {
  position: fixed; top: 0; right: -720px; width: 720px; max-width: 100%;
  height: 100vh; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.15);
  transition: right 0.3s ease; z-index: 1050; overflow: visible; display: flex; flex-direction: column;
}
.nomenclature-sidebar.open { right: 0; }
.nomenclature-sidebar-header {
  padding: 16px 20px; border-bottom: 1px solid #dee2e6;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; flex-shrink: 0;
}
.nomenclature-sidebar-body { flex: 1; overflow: visible; display: flex; flex-direction: column; padding: 16px; }
.nomenclature-sidebar-body .table-responsive { flex: 1; overflow: visible !important; max-height: none !important; }
.nomenclature-sidebar-footer {
  padding: 16px 0 0; border-top: 1px solid #dee2e6; flex-shrink: 0; margin-top: auto;
}
#nomenclatureTable th:nth-child(2),
#nomenclatureTable td:nth-child(2) {
  min-width: 150px;
  width: 150px;
}
</style>

<script>
function openNomenclatureSidebar() {
  document.getElementById('nomenclatureSidebar').classList.add('open');
  document.getElementById('nomenclatureSidebarOverlay').classList.add('show');
  document.body.style.overflow = 'hidden';
}
function closeNomenclatureSidebar() {
  document.getElementById('nomenclatureSidebar').classList.remove('open');
  document.getElementById('nomenclatureSidebarOverlay').classList.remove('show');
  document.body.style.overflow = '';
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeNomenclatureSidebar();
});

// Фильтрация таблицы по типу номенклатуры
var typeFilter = document.getElementById('nomenclatureTypeFilter');
if (typeFilter) {
  typeFilter.addEventListener('change', function() {
    var selectedTypeId = this.value;
    var table = document.getElementById('nomenclatureTable');
    if (!table) return;
    
    var rows = table.querySelectorAll('tbody tr');
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
      var row = rows[i];
      var typeId = row.getAttribute('data-type-id') || '';
      
      if (selectedTypeId === '' || typeId === selectedTypeId) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    }
    
    // Показываем сообщение, если нет видимых строк
    var tbody = table.querySelector('tbody');
    var noResultsRow = tbody.querySelector('tr.no-results');
    if (visibleCount === 0 && selectedTypeId !== '') {
      if (!noResultsRow) {
        noResultsRow = document.createElement('tr');
        noResultsRow.className = 'no-results';
        noResultsRow.innerHTML = '<td colspan="5" class="text-muted text-center">Нет позиций выбранного типа</td>';
        tbody.appendChild(noResultsRow);
      }
      noResultsRow.style.display = '';
    } else if (noResultsRow) {
      noResultsRow.style.display = 'none';
    }
  });
}

// Перед отправкой формы собираем выбранные id в одно поле (через запятую)
document.getElementById('nomenclatureSelectForm').addEventListener('submit', function(e) {
  var checked = document.querySelectorAll('#nomenclatureSelectForm input.nomenclature-cb:checked');
  var ids = [];
  for (var i = 0; i < checked.length; i++) {
    // Проверяем, что чекбокс видим (не скрыт фильтром)
    var row = checked[i].closest('tr');
    if (row && row.style.display !== 'none') {
      ids.push(checked[i].value);
    }
  }
  document.getElementById('nomenclatureItemIdsHidden').value = ids.join(',');
  if (ids.length === 0) {
    e.preventDefault();
    alert('Выберите хотя бы одну позицию номенклатуры.');
    return false;
  }
});
</script>

<!-- jQuery (требуется для DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<!-- DataTables CSS и JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<style>
.editable-quantity {
  cursor: pointer;
  position: relative;
  transition: background-color 0.2s;
}
.editable-quantity:hover {
  background-color: #e3f2fd;
}
.editable-quantity input {
  width: 100%;
  text-align: center;
  border: 2px solid #2196F3;
  border-radius: 4px;
}
</style>

<script>
$(document).ready(function() {
  // Инициализация DataTable (дерево по типам — сортировка отключена)
  var table = $('#specItemsTable').DataTable({
    language: {
      url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/ru.json'
    },
    paging: false,
    ordering: false,
    info: true,
    columnDefs: [
      { orderable: false, targets: '_all' }
    ]
  });

  // Inline редактирование количества
  $('#specItemsTable tbody').on('click', 'td.editable-quantity', function() {
    var $td = $(this);
    if ($td.find('input').length > 0) {
      return; // Уже в режиме редактирования
    }
    
    var currentValue = parseFloat($td.data('quantity')) || 0;
    var $input = $('<input>', {
      type: 'number',
      class: 'form-control form-control-sm',
      value: currentValue,
      min: '0.01',
      step: 'any'
    });
    
    $td.html($input);
    $input.focus().select();
    
    // Сохранение при потере фокуса или Enter
    var saveValue = function() {
      var newValue = parseFloat($input.val());
      if (isNaN(newValue) || newValue <= 0) {
        $td.html(currentValue);
        return;
      }
      
      var itemId = $td.closest('tr').data('item-id');
      var price = parseFloat($td.closest('tr').data('price')) || 0;
      var newTotal = newValue * price;
      
      // Форматирование числа для отображения
      var formatNumber = function(num) {
        return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      };
      
      // AJAX запрос на обновление
      $.ajax({
        url: '{{=URL("specifications", "edit_item_quantity", args=["__ITEM_ID__"])}}'.replace('__ITEM_ID__', itemId),
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        data: { quantity: newValue },
        dataType: 'json',
        success: function(response) {
          if (response.success) {
            $td.data('quantity', newValue);
            $td.html(newValue);
            $td.closest('tr').find('.item-total').html('<strong>' + formatNumber(newTotal) + ' ₽</strong>');
            // Перезагружаем страницу для обновления итога и синхронизации данных
            location.reload();
          } else {
            alert('Ошибка при сохранении: ' + (response.error || 'Неизвестная ошибка'));
            $td.html(currentValue);
          }
        },
        error: function(xhr, status, error) {
          var errorMsg = 'Ошибка при сохранении';
          try {
            var jsonResponse = JSON.parse(xhr.responseText);
            if (jsonResponse.error) {
              errorMsg = jsonResponse.error;
            }
          } catch(e) {
            errorMsg += ': ' + (xhr.responseText || error);
          }
          alert(errorMsg);
          $td.html(currentValue);
        }
      });
    };
    
    $input.on('blur', saveValue);
    $input.on('keypress', function(e) {
      if (e.which === 13) {
        e.preventDefault();
        saveValue();
      } else if (e.which === 27) {
        $td.html(currentValue);
      }
    });
  });
});
</script>
