{{extend 'layout_gentelella_bs5.html'}}

{{block header}}
{{if breadcrumbs:}}
<nav aria-label="breadcrumb" class="mb-2">
  <ol class="breadcrumb mb-0">
    {{for crumb in breadcrumbs:}}
    {{if crumb['url']:}}
    <li class="breadcrumb-item"><a href="{{=crumb['url']}}">{{=crumb['label']}}</a></li>
    {{else:}}
    <li class="breadcrumb-item active" aria-current="page">{{=crumb['label']}}</li>
    {{pass}}
    {{pass}}
  </ol>
</nav>
{{pass}}
{{end}}

<div class="container-fluid mt-2">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="card-title mb-0"><i class="bi bi-people me-2"></i> Пользователи</h5>
                    <button type="button" class="btn btn-primary btn-sm ms-auto" onclick="openSidebar()">
                        <i class="bi bi-plus me-1"></i> Добавить пользователя
                    </button>
                </div>
                <div class="card-body">
                    {{if users:}}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Логин</th>
                                    <th>Email</th>
                                    <th>Имя</th>
                                    <th>Фамилия</th>
                                    <th>Филиал</th>
                                    <th>Роль</th>
                                    <th class="text-nowrap" style="min-width: 100px;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{for row in users:}}
                                <tr>
                                    <td>{{=row.auth_user.id}}</td>
                                    <td><strong>{{=row.auth_user.nic or '-'}}</strong></td>
                                    <td>{{=row.auth_user.email or '-'}}</td>
                                    <td>{{=row.auth_user.first_name or '-'}}</td>
                                    <td>{{=row.auth_user.last_name or '-'}}</td>
                                    <td>{{=row.branches.name if row.branches else '-'}}</td>
                                    <td>{{=row.user_roles.name if row.user_roles else '-'}}</td>
                                    <td class="text-nowrap actions-cell">
                                        <a href="{{=URL('users', 'list', vars=dict(edit=row.auth_user.id))}}" class="btn btn-sm btn-primary me-2" title="Редактировать"><i class="bi bi-pencil"></i></a>
                                        <a href="{{=URL('users', 'delete', args=[row.auth_user.id])}}" class="btn btn-sm btn-danger" title="Удалить" onclick="return confirm('Удалить пользователя {{=row.auth_user.email or row.auth_user.id}}?');"><i class="bi bi-trash"></i></a>
                                    </td>
                                </tr>
                                {{pass}}
                            </tbody>
                        </table>
                    </div>
                    {{else:}}
                    <div class="alert alert-info">
                        <p class="mb-0"><i class="bi bi-info-circle"></i> Пользователи не найдены. <button type="button" class="btn btn-link btn-sm p-0 align-baseline" onclick="openSidebar()">Добавьте первого пользователя</button></p>
                    </div>
                    {{pass}}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.table th { background-color: #f8f9fa; font-weight: 600; }
.table td.actions-cell { min-width: 180px; white-space: nowrap; }
.user-sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 1040; display: none; }
.user-sidebar-overlay.show { display: block; }
.user-sidebar { position: fixed; top: 0; right: -420px; width: 420px; max-width: 100vw; height: 100vh; background: var(--bs-body-bg); box-shadow: -2px 0 12px rgba(0,0,0,.15); transition: right 0.3s ease; z-index: 1050; overflow-y: auto; display: flex; flex-direction: column; }
.user-sidebar.open { right: 0; }
.user-edit-sidebar.open { right: 0; }
.user-sidebar .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--bs-border-color); background: var(--bs-primary); color: #fff; }
.user-sidebar .sidebar-body { padding: 1rem; flex: 1; overflow-y: auto; }
</style>

<div class="user-sidebar-overlay" id="userOverlay" onclick="closeAllSidebars()"></div>
<div class="user-sidebar" id="userSidebar">
  <div class="sidebar-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0 text-white"><i class="bi bi-person-plus me-2"></i> Добавление пользователя</h5>
    <button type="button" class="btn btn-light btn-sm" onclick="closeSidebar()"><i class="bi bi-x-lg"></i></button>
  </div>
  <div class="sidebar-body">
    {{=form_add.custom.begin}}
    {{if form_add.errors:}}
    <div class="alert alert-danger">
      <strong>Ошибки:</strong>
      <ul class="mb-0">{{for field, error in form_add.errors.items():}}<li>{{=field}}: {{=error}}</li>{{pass}}</ul>
    </div>
    {{pass}}
    <div class="mb-3"><label class="form-label">Логин (nic) <span class="text-danger">*</span></label>{{=form_add.custom.widget.nic}}</div>
    <div class="mb-3"><label class="form-label">Email <span class="text-danger">*</span></label>{{=form_add.custom.widget.email}}</div>
    <div class="mb-3"><label class="form-label">Имя</label>{{=form_add.custom.widget.first_name}}</div>
    <div class="mb-3"><label class="form-label">Фамилия</label>{{=form_add.custom.widget.last_name}}</div>
    <div class="mb-3"><label class="form-label">Филиал</label>{{=form_add.custom.widget.branch_id}}</div>
    <div class="mb-3"><label class="form-label">Роль</label>{{=form_add.custom.widget.role_id}}</div>
    <div class="mb-3"><label class="form-label">Пароль <span class="text-danger">*</span></label>{{=form_add.custom.widget.password}}</div>
    <div class="mb-3">{{=form_add.custom.submit}}<button type="button" class="btn btn-secondary w-100 mt-2" onclick="closeSidebar()">Отмена</button></div>
    {{=form_add.custom.end}}
  </div>
</div>

{{if form_edit:}}
<div class="user-sidebar user-edit-sidebar" id="userEditSidebar">
  <div class="sidebar-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0 text-white"><i class="bi bi-pencil me-2"></i> Редактирование пользователя</h5>
    <a href="{{=URL('users', 'list')}}" class="btn btn-light btn-sm"><i class="bi bi-x-lg"></i></a>
  </div>
  <div class="sidebar-body">
    {{=form_edit.custom.begin}}
    <input type="hidden" name="edit" value="{{=edit_record.id}}" />
    {{if form_edit.errors:}}
    <div class="alert alert-danger">
      <strong>Ошибки:</strong>
      <ul class="mb-0">{{for field, error in form_edit.errors.items():}}<li>{{=field}}: {{=error}}</li>{{pass}}</ul>
    </div>
    {{pass}}
    <div class="mb-3"><label class="form-label">Логин (nic) <span class="text-danger">*</span></label>{{=form_edit.custom.widget.nic}}</div>
    <div class="mb-3"><label class="form-label">Email <span class="text-danger">*</span></label>{{=form_edit.custom.widget.email}}</div>
    <div class="mb-3"><label class="form-label">Имя</label>{{=form_edit.custom.widget.first_name}}</div>
    <div class="mb-3"><label class="form-label">Фамилия</label>{{=form_edit.custom.widget.last_name}}</div>
    <div class="mb-3"><label class="form-label">Филиал</label>{{=form_edit.custom.widget.branch_id}}</div>
    <div class="mb-3"><label class="form-label">Роль</label>{{=form_edit.custom.widget.role_id}}</div>
    <div class="mb-3">{{=form_edit.custom.submit}}<a href="{{=URL('users', 'list')}}" class="btn btn-secondary w-100 mt-2">Отмена</a></div>
    {{=form_edit.custom.end}}
  </div>
</div>
{{pass}}

<script>
function openSidebar() { document.getElementById('userSidebar').classList.add('open'); document.getElementById('userOverlay').classList.add('show'); document.body.style.overflow = 'hidden'; }
function closeSidebar() { var s = document.getElementById('userSidebar'); if(s) s.classList.remove('open'); document.getElementById('userOverlay').classList.remove('show'); document.body.style.overflow = ''; }
function closeEditSidebar() { var el = document.getElementById('userEditSidebar'); if (el) el.classList.remove('open'); document.getElementById('userOverlay').classList.remove('show'); document.body.style.overflow = ''; }
function closeAllSidebars() { closeSidebar(); closeEditSidebar(); }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeAllSidebars(); });
{{if show_edit_panel:}}
(function openEditPanelOnLoad() { var overlay = document.getElementById('userOverlay'); var panel = document.getElementById('userEditSidebar'); if (panel && overlay) { panel.classList.add('open'); overlay.classList.add('show'); document.body.style.overflow = 'hidden'; } })();
{{pass}}
</script>
