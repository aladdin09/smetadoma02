{{extend 'layout_gentelella_bs5.html'}}

{{block header}}
<div class="jumbotron jumbotron-fluid" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:40px;">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="display-4"><i class="bi bi-file-text-o"></i> Карточка заявки</h1>
        <p class="lead">Заявка #{{=request_obj.id}} - {{=customer.name if customer else 'Клиент не найден'}}</p>
      </div>
      <div>
        <a href="{{=URL('customers', 'customer', args=[request_obj.customer_id])}}" class="btn btn-light btn-lg">
          <i class="bi bi-arrow-left"></i> Назад к клиенту
        </a>
      </div>
    </div>
  </div>
</div>
{{end}}

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Информация о заявке -->
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Информация о заявке</h5>
        </div>
        <div class="card-body">
          <table class="table table-borderless">
            <tr>
              <th width="40%">ID:</th>
              <td>#{{=request_obj.id}}</td>
            </tr>
            <tr>
              <th>Клиент:</th>
              <td>
                <a href="{{=URL('customers', 'customer', args=[request_obj.customer_id])}}">
                  {{=customer.name if customer else 'Неизвестно'}}
                </a>
              </td>
            </tr>
            <tr>
              <th>Статус:</th>
              <td>
                {{if status:}}
                  {{status_color = status_colors.get(status.id, 'secondary') if status_colors else 'secondary'}}
                  <span class="badge bg-{{=status_color}}">{{=status.name}}</span>
                {{else:}}
                  <span class="badge bg-secondary">Неизвестно</span>
                {{pass}}
              </td>
            </tr>
            <tr>
              <th>Дата изменения статуса:</th>
              <td>{{=request_obj.status_changed_on.strftime('%d.%m.%Y %H:%M') if request_obj.status_changed_on else '-'}}</td>
            </tr>
            {{if next_step:}}
            <tr>
              <th>Следующий шаг:</th>
              <td>{{=next_step.name}}</td>
            </tr>
            {{pass}}
            {{if request_obj.execution_time:}}
            <tr>
              <th>Время выполнения:</th>
              <td>{{=request_obj.execution_time}} дней</td>
            </tr>
            {{pass}}
            {{if request_obj.deadline:}}
            <tr>
              <th>Дедлайн:</th>
              <td>{{=request_obj.deadline.strftime('%d.%m.%Y %H:%M')}}</td>
            </tr>
            {{pass}}
            <tr>
              <th>Общая сумма:</th>
              <td><strong>{{=f"{float(request_obj.total_amount or 0):,.2f}".replace(',', ' ')}} ₽</strong></td>
            </tr>
            {{if request_obj.description:}}
            <tr>
              <th>Описание:</th>
              <td>{{=request_obj.description}}</td>
            </tr>
            {{pass}}
            <tr>
              <th>Дата создания:</th>
              <td>{{=request_obj.created_on.strftime('%d.%m.%Y %H:%M') if request_obj.created_on else '-'}}</td>
            </tr>
            <tr>
              <th>Дата изменения:</th>
              <td>{{=request_obj.modified_on.strftime('%d.%m.%Y %H:%M') if request_obj.modified_on else '-'}}</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Позиции заявки -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-list"></i> Позиции заявки</h5>
          <button type="button" class="btn btn-light btn-sm" onclick="alert('Добавление позиций будет реализовано позже')">
            <i class="bi bi-plus"></i> Добавить позицию
          </button>
        </div>
        <div class="card-body">
          {{if request_items:}}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Количество</th>
                  <th>Единица</th>
                  <th>Цена</th>
                  <th>Итого</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                {{for item in request_items:}}
                <tr>
                  <td>{{=item.item_name}}</td>
                  <td>{{=item.quantity}}</td>
                  <td>{{=item.unit}}</td>
                  <td>{{=f"{float(item.price or 0):,.2f}".replace(',', ' ')}} ₽</td>
                  <td><strong>{{=f"{float(item.total or 0):,.2f}".replace(',', ' ')}} ₽</strong></td>
                  <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="alert('Удаление будет реализовано позже')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                {{pass}}
              </tbody>
              <tfoot>
                <tr class="table-info">
                  <th colspan="4" class="text-right">Итого:</th>
                  <th>{{=f"{float(request_obj.total_amount or 0):,.2f}".replace(',', ' ')}} ₽</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
          {{else:}}
          <p class="text-muted text-center">Позиции заявки отсутствуют</p>
          {{pass}}
        </div>
      </div>
    </div>
  </div>
</div>
