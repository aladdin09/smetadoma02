{{extend 'layout_gentelella.html'}}

{{block head}}
{{end}}

<div class="row">
  <div class="col-md-4 col-sm-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-list"></i> Проекты по статусам</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="dashboard-status-cards-vertical">
          {{for stat in dashboard_stats:}}
          {{if total_projects > 0:}}
          {{percentage = int((stat['count'] / total_projects) * 100)}}
          {{else:}}
          {{percentage = 0}}
          {{pass}}
          {{gcolor = 'default' if stat['color'] == 'secondary' else stat['color']}}
          <div class="list-item dashboard-status-card border-left border-{{=gcolor}}" style="cursor: pointer; border-left-width: 3px !important;" data-status-name="{{=stat['name']}}" title="Показать проекты со статусом «{{=stat['name']}}»">
            <div class="pull-left" style="font-size: 0.9rem; font-weight: bold;">{{=stat['name']}}</div>
            <div class="pull-right"><span class="label label-{{=gcolor}}">{{=stat['count']}}</span></div>
            <div class="clearfix"></div>
            <div class="progress" style="height: 4px; margin-top: 6px;">
              <div class="progress-bar progress-bar-{{=gcolor}}" style="width: {{=percentage}}%"></div>
            </div>
            <span class="small" style="font-size: 0.8rem; font-weight: bold;">{{=f"{stat.get('sum', 0):,.2f}".replace(',', ' ')}} ₽</span>
          </div>
          {{pass}}
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-8 col-sm-12" id="dashboard-projects-table">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-list"></i> Все проекты</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a href="javascript:;" id="btnResetFilter" class="btn btn-default btn-sm"><i class="fa fa-times"></i> Сбросить фильтр</a></li>
        </ul>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="table-responsive">
          <table id="projectsTable" class="table table-striped table-bordered jambo_table" style="width:100%">
            <thead>
              <tr class="headings">
                <th>Номер проекта</th>
                <th>Название</th>
                <th>Клиент</th>
                <th>Статус</th>
                <th title="Сумма спецификаций">Общая сумма спецификации</th>
                <th>Дата начала</th>
                <th>Дата окончания</th>
                <th>Дата создания</th>
              </tr>
            </thead>
            <tbody>
              {{if projects:}}
              {{for project in projects:}}
              <tr class="project-row even pointer" data-href="{{=URL('projects', 'view', args=[project.projects.id])}}" data-status="{{=project.project_statuses.name if project.project_statuses else ''}}" style="cursor: pointer;">
                <td data-order="{{=project.projects.project_number or ''}}"><strong>{{=project.projects.project_number or '-'}}</strong></td>
                <td>{{=project.projects.name}}</td>
                <td onclick="event.stopPropagation();">
                  {{if project.customers:}}
                    <a href="{{=URL('customers', 'customer', args=[project.projects.customer_id])}}">{{=project.customers.name}}</a>
                  {{else:}}-{{pass}}
                </td>
                <td>
                  {{if project.project_statuses:}}
                    {{status_id = project.projects.status_id}}
                    {{status_color = status_colors.get(status_id, 'default') if status_id else 'default'}}
                    {{status_color = 'default' if status_color == 'secondary' else status_color}}
                    <span class="label label-{{=status_color}}">{{=project.project_statuses.name}}</span>
                  {{else:}}<span class="label label-default">-</span>{{pass}}
                </td>
                <td data-order="{{=float(project_specification_sums.get(project.projects.id, 0))}}">
                  {{specification_sum = project_specification_sums.get(project.projects.id, 0)}}
                  <strong>{{=f"{specification_sum:,.2f}".replace(',', ' ')}} ₽</strong>
                </td>
                <td data-order="{{=project.projects.start_date.isoformat() if project.projects.start_date else ''}}">{{=project.projects.start_date.strftime('%d.%m.%Y') if project.projects.start_date else '-'}}</td>
                <td data-order="{{=project.projects.end_date.isoformat() if project.projects.end_date else ''}}">{{=project.projects.end_date.strftime('%d.%m.%Y') if project.projects.end_date else '-'}}</td>
                <td data-order="{{=project.projects.created_on.strftime('%Y-%m-%d %H:%M') if project.projects.created_on else ''}}">{{=project.projects.created_on.strftime('%d.%m.%Y %H:%M') if project.projects.created_on else '-'}}</td>
              </tr>
              {{pass}}
              {{else:}}
              <tr><td colspan="8" class="text-center text-muted"><i class="fa fa-info-circle"></i> Проекты не найдены</td></tr>
              {{pass}}
            </tbody>
            <tfoot>
              <tr class="info">
                <td colspan="4" class="text-right"><strong>Общая сумма:</strong></td>
                <td id="dashboard-specification-sum-total"><strong>{{=f"{dashboard_specification_total:,.2f}".replace(',', ' ')}} ₽</strong></td>
                <td colspan="3"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.customer-sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 1040; display: none; }
.customer-sidebar-overlay.show { display: block; }
.customer-sidebar { position: fixed; top: 0; right: -500px; width: 500px; height: 100vh; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1050; overflow-y: auto; }
.customer-sidebar.open { right: 0; }
.customer-sidebar .customer-sidebar-header { padding: 15px; border-bottom: 1px solid #E6E9ED; background: #1ABB9C; color: white; }
.customer-sidebar .customer-sidebar-body { padding: 15px; }
.dashboard-status-cards-vertical .list-item { padding: 8px 12px; margin-bottom: 8px; background: #fff; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,.06); border: 1px solid #E6E9ED; }
.dashboard-status-cards-vertical .list-item:hover { background: #F2F5F7; }
.table tbody tr.project-row:hover td { background: rgba(38, 185, 154, 0.07) !important; }
</style>

<div class="customer-sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<div class="customer-sidebar {{='open' if show_customer_panel else ''}}" id="customerSidebar">
  <div class="customer-sidebar-header">
    <div class="pull-left"><h4 style="margin: 0;"><i class="fa fa-user-plus"></i> Добавление клиента</h4></div>
    <div class="pull-right"><button type="button" class="btn btn-default btn-sm" onclick="closeSidebar()"><i class="fa fa-times"></i></button></div>
    <div class="clearfix"></div>
  </div>
  <div class="customer-sidebar-body">
    {{=form_customer.custom.begin}}
    {{if form_customer.errors:}}
    <div class="alert alert-danger">
      <strong>Ошибки:</strong>
      <ul class="mb-0">{{for field, error in form_customer.errors.items():}}<li>{{=field}}: {{=error}}</li>{{pass}}</ul>
    </div>
    {{pass}}
    <div class="form-group"><label for="customers_name">Имя клиента <span class="text-danger">*</span></label>{{=form_customer.custom.widget.name}}</div>
    <div class="form-group"><label for="customers_phone">Телефон</label>{{=form_customer.custom.widget.phone}}</div>
    <div class="form-group"><label for="customers_email">Email</label>{{=form_customer.custom.widget.email}}</div>
    <div class="form-group"><label for="customers_address">Адрес</label>{{=form_customer.custom.widget.address}}</div>
    <div class="form-group"><label for="customers_notes">Примечания</label>{{=form_customer.custom.widget.notes}}</div>
    <div class="form-group">{{=form_customer.custom.submit}}<button type="button" class="btn btn-default btn-block" style="margin-top: 10px;" onclick="closeSidebar()">Отмена</button></div>
    {{=form_customer.custom.end}}
  </div>
</div>

{{block page_js}}
<script>
function openSidebar() { document.getElementById('customerSidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.add('show'); document.body.style.overflow = 'hidden'; }
function closeSidebar() { document.getElementById('customerSidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); document.body.style.overflow = ''; }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeSidebar(); });
$(function() {
  function updateDashboardSum() {
    var total = 0;
    $('#projectsTable tbody tr.project-row:visible').each(function() { total += parseFloat($(this).find('td').eq(4).attr('data-order')) || 0; });
    $('#dashboard-specification-sum-total').html('<strong>' + total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ₽</strong>');
  }
  $('#projectsTable').on('click', 'tbody tr.project-row', function(e) {
    if ($(e.target).closest('a').length) return;
    var href = $(this).data('href'); if (href) window.location.href = href;
  });
  $(document).on('click', '.dashboard-status-card', function() {
    var statusName = $(this).data('status-name');
    if (statusName) {
      $('#projectsTable tbody tr.project-row').each(function() { $(this).toggle($(this).data('status') === statusName); });
      updateDashboardSum();
      document.getElementById('dashboard-projects-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
  $('#btnResetFilter').on('click', function() { $('#projectsTable tbody tr.project-row').show(); updateDashboardSum(); });
});
</script>
{{end}}
