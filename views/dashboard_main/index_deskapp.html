{{extend 'layout_gentelella_bs5.html'}}

{{block head}}
<link rel="stylesheet" type="text/css" href="{{=URL('static','deskapp/vendors/styles/core.css')}}">
<link rel="stylesheet" type="text/css" href="{{=URL('static','deskapp/vendors/styles/icon-font.min.css')}}">
<link rel="stylesheet" type="text/css" href="{{=URL('static','deskapp/vendors/styles/style.css')}}">
<link rel="stylesheet" type="text/css" href="{{=URL('static','deskapp/src/styles/theme.css')}}">
<link rel="stylesheet" type="text/css" href="{{=URL('static','deskapp/src/styles/style.css')}}">
<link rel="stylesheet" type="text/css" href="{{=URL('static','deskapp/src/styles/media.css')}}">
{{end}}

{{block header}}
{{end}}

<div class="container-fluid mt-2">
  <div class="row">
    <!-- Левая колонка 1/3 — плашки по статусам -->
    <div class="col-12 col-lg-4 mb-4">
      <h6 class="mb-2"><i class="bi bi-list"></i> Проекты по статусам</h6>
      <div class="dashboard-status-cards-vertical">
        {{for stat in dashboard_stats:}}
        {{if total_projects > 0:}}
        {{percentage = int((stat['count'] / total_projects) * 100)}}
        {{else:}}
        {{percentage = 0}}
        {{pass}}
        <div class="list-item dashboard-status-card border-left border-{{=stat['color']}}" style="cursor: pointer; border-left-width: 3px !important;" data-status-name="{{=stat['name']}}" title="Показать проекты со статусом «{{=stat['name']}}»">
          <div class="d-flex justify-content-between align-items-center">
            <span class="font-weight-medium" style="font-size: 0.9rem;">{{=stat['name']}}</span>
            <span class="badge bg-{{=stat['color']}} badge-pill">{{=stat['count']}}</span>
          </div>
          <div class="progress mt-1" style="height: 4px;">
            <div class="progress-bar bg-{{=stat['color']}}" style="width: {{=percentage}}%"></div>
          </div>
          <span class="small font-weight-bold" style="font-size: 0.8rem;">{{=f"{stat.get('sum', 0):,.2f}".replace(',', ' ')}} ₽</span>
        </div>
        {{pass}}
      </div>
    </div>

    <!-- Правая колонка 2/3 — таблица -->
    <div class="col-12 col-lg-8" id="dashboard-projects-table">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-list"></i> Все проекты</h5>
          <button type="button" id="btnResetFilter" class="btn btn-sm btn-secondary">
            <i class="bi bi-times"></i> Сбросить фильтр
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table id="projectsTable" class="table table-striped table-bordered" style="width:100%">
              <thead class="thead-light">
                <tr>
                  <th>Номер проекта</th>
                  <th>Название</th>
                  <th>Клиент</th>
                  <th>Статус</th>
                  <th title="Сумма спецификаций: КП у РОПа, Исправление КП, КП согласовано, КП отправлено, Заказ оформлен">Общая сумма спецификации</th>
                  <th>Дата начала</th>
                  <th>Дата окончания</th>
                  <th>Дата создания</th>
                </tr>
              </thead>
              <tbody>
                {{if projects:}}
                {{for project in projects:}}
                <tr class="project-row" data-href="{{=URL('projects', 'view', args=[project.projects.id])}}" data-status="{{=project.project_statuses.name if project.project_statuses else ''}}" style="cursor: pointer;">
                  <td data-order="{{=project.projects.project_number or ''}}"><strong>{{=project.projects.project_number or '-'}}</strong></td>
                  <td>{{=project.projects.name}}</td>
                  <td onclick="event.stopPropagation();">
                    {{if project.customers:}}
                      <a href="{{=URL('customers', 'customer', args=[project.projects.customer_id])}}">
                        {{=project.customers.name}}
                      </a>
                    {{else:}}
                      -
                    {{pass}}
                  </td>
                  <td>
                    {{if project.project_statuses:}}
                      {{status_id = project.projects.status_id}}
                      {{status_color = status_colors.get(status_id, 'secondary') if status_id else 'secondary'}}
                      <span class="badge bg-{{=status_color}}">
                        {{=project.project_statuses.name}}
                      </span>
                    {{else:}}
                      <span class="badge bg-secondary">-</span>
                    {{pass}}
                  </td>
                  <td data-order="{{=float(project_specification_sums.get(project.projects.id, 0))}}">
                    {{specification_sum = project_specification_sums.get(project.projects.id, 0)}}
                    <strong>{{=f"{specification_sum:,.2f}".replace(',', ' ')}} ₽</strong>
                  </td>
                  <td data-order="{{=project.projects.start_date.isoformat() if project.projects.start_date else ''}}">{{=project.projects.start_date.strftime('%d.%m.%Y') if project.projects.start_date else '-'}}</td>
                  <td data-order="{{=project.projects.end_date.isoformat() if project.projects.end_date else ''}}">{{=project.projects.end_date.strftime('%d.%m.%Y') if project.projects.end_date else '-'}}</td>
                  <td data-order="{{=project.projects.created_on.strftime('%Y-%m-%d %H:%M') if project.projects.created_on else ''}}">{{=project.projects.created_on.strftime('%d.%m.%Y %H:%M') if project.projects.created_on else '-'}}</td>
                </tr>
                {{pass}}
                {{else:}}
                <tr>
                  <td colspan="8" class="text-center text-muted">
                    <i class="bi bi-info-circle"></i> Проекты не найдены
                  </td>
                </tr>
                {{pass}}
              </tbody>
              <tfoot>
                <tr class="table-info font-weight-bold">
                  <td colspan="4" class="text-right">Общая сумма:</td>
                  <td id="dashboard-complect-sum-total">{{=f"{dashboard_complect_total:,.2f}".replace(',', ' ')}} ₽</td>
                  <td colspan="3"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Минимальные стили только для сайдбара (DeskApp такого нет). Остальное — DeskApp + layout. -->
<style>
.sidebar { position: fixed; top: 0; right: -500px; width: 500px; height: 100vh; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,.1); transition: right 0.3s ease; z-index: 1050; overflow-y: auto; }
.sidebar.open { right: 0; }
.sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 1040; display: none; }
.sidebar-overlay.show { display: block; }
{{if show_customer_panel:}}.sidebar-overlay { display: block; }{{pass}}
.sidebar-header { padding: 20px; border-bottom: 1px solid #dee2e6; }
.sidebar-body { padding: 20px; }
</style>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<div class="sidebar {{='open' if show_customer_panel else ''}}" id="customerSidebar">
  <div class="sidebar-header">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="bi bi-user-plus"></i> Добавление клиента</h4>
      <button type="button" class="btn btn-light btn-sm" onclick="closeSidebar()"><i class="bi bi-times"></i></button>
    </div>
  </div>
  <div class="sidebar-body">
    {{=form_customer.custom.begin}}
    {{if form_customer.errors:}}
    <div class="alert alert-danger">
      <strong>Ошибки:</strong>
      <ul class="mb-0">{{for field, error in form_customer.errors.items():}}<li>{{=field}}: {{=error}}</li>{{pass}}</ul>
    </div>
    {{pass}}
    <div class="form-group"><label for="customers_name">Имя клиента <span class="text-danger">*</span></label>{{=form_customer.custom.widget.name}}</div>
    <div class="form-group"><label for="customers_phone">Телефон</label>{{=form_customer.custom.widget.phone}}</div>
    <div class="form-group"><label for="customers_email">Email</label>{{=form_customer.custom.widget.email}}</div>
    <div class="form-group"><label for="customers_address">Адрес</label>{{=form_customer.custom.widget.address}}</div>
    <div class="form-group"><label for="customers_notes">Примечания</label>{{=form_customer.custom.widget.notes}}</div>
    <div class="form-group">{{=form_customer.custom.submit}}<button type="button" class="btn btn-secondary btn-block mt-2" onclick="closeSidebar()">Отмена</button></div>
    {{=form_customer.custom.end}}
  </div>
</div>

{{block page_js}}
<script src="{{=URL('static','deskapp/vendors/scripts/core.js')}}"></script>
<script src="{{=URL('static','deskapp/vendors/scripts/script.min.js')}}"></script>
<script src="{{=URL('static','deskapp/vendors/scripts/process.js')}}"></script>
<script src="{{=URL('static','deskapp/vendors/scripts/layout-settings.js')}}"></script>
<script>
function openSidebar() { document.getElementById('customerSidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.add('show'); document.body.style.overflow = 'hidden'; }
function closeSidebar() { document.getElementById('customerSidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); document.body.style.overflow = ''; }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeSidebar(); });
$(function() {
  function updateDashboardSum() {
    var total = 0;
    $('#projectsTable tbody tr.project-row:visible').each(function() { total += parseFloat($(this).find('td').eq(4).attr('data-order')) || 0; });
    $('#dashboard-specification-sum-total').text(total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ₽');
  }
  $('#projectsTable').on('click', 'tbody tr.project-row', function(e) {
    if ($(e.target).closest('a').length) return;
    var href = $(this).data('href'); if (href) window.location.href = href;
  });
  $(document).on('click', '.dashboard-status-card', function() {
    var statusName = $(this).data('status-name');
    if (statusName) {
      $('#projectsTable tbody tr.project-row').each(function() { $(this).toggle($(this).data('status') === statusName); });
      updateDashboardSum();
      document.getElementById('dashboard-projects-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
  $('#btnResetFilter').on('click', function() { $('#projectsTable tbody tr.project-row').show(); updateDashboardSum(); });
});
</script>
{{end}}
