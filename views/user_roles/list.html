{{extend 'layout_gentelella_bs5.html'}}

{{block header}}
{{if breadcrumbs:}}
<nav aria-label="breadcrumb" class="mb-2">
  <ol class="breadcrumb mb-0">
    {{for crumb in breadcrumbs:}}
    {{if crumb['url']:}}
    <li class="breadcrumb-item"><a href="{{=crumb['url']}}">{{=crumb['label']}}</a></li>
    {{else:}}
    <li class="breadcrumb-item active" aria-current="page">{{=crumb['label']}}</li>
    {{pass}}
    {{pass}}
  </ol>
</nav>
{{pass}}
{{end}}

<div class="container-fluid mt-2">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="card-title mb-0"><i class="bi bi-person-badge me-2"></i> Список ролей</h5>
                    <button type="button" class="btn btn-primary btn-sm ms-auto" onclick="openSidebar()">
                        <i class="bi bi-plus me-1"></i> Добавить роль
                    </button>
                </div>
                <div class="card-body">
                    {{if roles:}}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Описание</th>
                                    <th>Порядок сортировки</th>
                                    <th>Активна</th>
                                    <th class="text-nowrap" style="min-width: 100px;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{for role in roles:}}
                                <tr>
                                    <td>{{=role.id}}</td>
                                    <td><strong>{{=role.name}}</strong></td>
                                    <td>{{=role.description or '-'}}</td>
                                    <td>{{=role.sort_order}}</td>
                                    <td>
                                        {{if role.is_active:}}
                                        <span class="badge bg-success">Да</span>
                                        {{else:}}
                                        <span class="badge bg-secondary">Нет</span>
                                        {{pass}}
                                    </td>
                                    <td class="text-nowrap actions-cell">
                                        <a href="{{=URL('user_roles', 'list', vars=dict(edit=role.id))}}" class="btn btn-sm btn-primary me-2" title="Редактировать"><i class="bi bi-pencil"></i></a>
                                        <a href="{{=URL('user_roles', 'delete', args=[role.id])}}" class="btn btn-sm btn-danger" title="Удалить" onclick="return confirm('Вы уверены, что хотите удалить эту роль?');"><i class="bi bi-trash"></i></a>
                                    </td>
                                </tr>
                                {{pass}}
                            </tbody>
                        </table>
                    </div>
                    {{else:}}
                    <div class="alert alert-info">
                        <p class="mb-0"><i class="bi bi-info-circle"></i> Роли не найдены. <button type="button" class="btn btn-link btn-sm p-0 align-baseline" onclick="openSidebar()">Создайте первую роль</button></p>
                    </div>
                    {{pass}}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.table th { background-color: #f8f9fa; font-weight: 600; }
.table td.actions-cell { min-width: 180px; white-space: nowrap; }
.user-role-sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 1040; display: none; }
.user-role-sidebar-overlay.show { display: block; }
.user-role-sidebar { position: fixed; top: 0; right: -420px; width: 420px; max-width: 100vw; height: 100vh; background: var(--bs-body-bg); box-shadow: -2px 0 12px rgba(0,0,0,.15); transition: right 0.3s ease; z-index: 1050; overflow-y: auto; display: flex; flex-direction: column; }
.user-role-sidebar.open { right: 0; }
.user-role-edit-sidebar.open { right: 0; }
.user-role-sidebar .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--bs-border-color); background: var(--bs-primary); color: #fff; }
.user-role-sidebar .sidebar-body { padding: 1rem; flex: 1; overflow-y: auto; }
</style>

<!-- Панель добавления роли справа -->
<div class="user-role-sidebar-overlay" id="userRoleOverlay" onclick="closeAllSidebars()"></div>
<div class="user-role-sidebar" id="userRoleSidebar">
  <div class="sidebar-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0 text-white"><i class="bi bi-person-badge me-2"></i> Добавление роли</h5>
    <button type="button" class="btn btn-light btn-sm" onclick="closeSidebar()"><i class="bi bi-x-lg"></i></button>
  </div>
  <div class="sidebar-body">
    {{=form_status.custom.begin}}
    {{if form_status.errors:}}
    <div class="alert alert-danger">
      <strong>Ошибки:</strong>
      <ul class="mb-0">{{for field, error in form_status.errors.items():}}<li>{{=field}}: {{=error}}</li>{{pass}}</ul>
    </div>
    {{pass}}
    <div class="mb-3"><label for="user_roles_name" class="form-label">Название <span class="text-danger">*</span></label>{{=form_status.custom.widget.name}}</div>
    <div class="mb-3"><label for="user_roles_description" class="form-label">Описание</label>{{=form_status.custom.widget.description}}</div>
    <div class="mb-3"><label for="user_roles_sort_order" class="form-label">Порядок сортировки</label>{{=form_status.custom.widget.sort_order}}</div>
    <div class="mb-3"><div class="form-check">{{=form_status.custom.widget.is_active}} <label class="form-check-label" for="user_roles_is_active">Активна</label></div></div>
    <div class="mb-3">{{=form_status.custom.submit}}<button type="button" class="btn btn-secondary w-100 mt-2" onclick="closeSidebar()">Отмена</button></div>
    {{=form_status.custom.end}}
  </div>
</div>

{{if form_edit:}}
<!-- Панель редактирования роли справа -->
<div class="user-role-sidebar user-role-edit-sidebar" id="userRoleEditSidebar">
  <div class="sidebar-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0 text-white"><i class="bi bi-pencil me-2"></i> Редактирование роли</h5>
    <a href="{{=URL('user_roles', 'list')}}" class="btn btn-light btn-sm"><i class="bi bi-x-lg"></i></a>
  </div>
  <div class="sidebar-body">
    {{=form_edit.custom.begin}}
    <input type="hidden" name="edit" value="{{=edit_role.id}}" />
    {{if form_edit.errors:}}
    <div class="alert alert-danger">
      <strong>Ошибки:</strong>
      <ul class="mb-0">{{for field, error in form_edit.errors.items():}}<li>{{=field}}: {{=error}}</li>{{pass}}</ul>
    </div>
    {{pass}}
    <div class="mb-3"><label class="form-label">Название <span class="text-danger">*</span></label>{{=form_edit.custom.widget.name}}</div>
    <div class="mb-3"><label class="form-label">Описание</label>{{=form_edit.custom.widget.description}}</div>
    <div class="mb-3"><label class="form-label">Порядок сортировки</label>{{=form_edit.custom.widget.sort_order}}</div>
    <div class="mb-3"><div class="form-check">{{=form_edit.custom.widget.is_active}} <label class="form-check-label">Активна</label></div></div>
    <div class="mb-3">{{=form_edit.custom.submit}}<a href="{{=URL('user_roles', 'list')}}" class="btn btn-secondary w-100 mt-2">Отмена</a></div>
    {{=form_edit.custom.end}}
  </div>
</div>
{{pass}}

<script>
function openSidebar() { document.getElementById('userRoleSidebar').classList.add('open'); document.getElementById('userRoleOverlay').classList.add('show'); document.body.style.overflow = 'hidden'; }
function closeSidebar() { var s = document.getElementById('userRoleSidebar'); if(s) s.classList.remove('open'); document.getElementById('userRoleOverlay').classList.remove('show'); document.body.style.overflow = ''; }
function closeEditSidebar() { var el = document.getElementById('userRoleEditSidebar'); if (el) el.classList.remove('open'); document.getElementById('userRoleOverlay').classList.remove('show'); document.body.style.overflow = ''; }
function closeAllSidebars() { closeSidebar(); closeEditSidebar(); }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeAllSidebars(); });
{{if show_edit_panel:}}
(function openEditPanelOnLoad() { var overlay = document.getElementById('userRoleOverlay'); var panel = document.getElementById('userRoleEditSidebar'); if (panel && overlay) { panel.classList.add('open'); overlay.classList.add('show'); document.body.style.overflow = 'hidden'; } })();
{{pass}}
</script>
